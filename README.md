# Filmorate ‚Äî —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∏–ª—å–º–æ–≤ –∏ –æ–±—â–µ–Ω–∏—è

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:**
- Java 11
- Spring Boot 3
- H2 Database
- JDBC
- Maven
- Lombok

Filmorate ‚Äî —ç—Ç–æ Java-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:

- –•—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å–º–∞—Ö (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –∂–∞–Ω—Ä—ã, —Ä–µ–π—Ç–∏–Ω–≥ MPA –∏ —Ç.–¥.)
- –°—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏ —Ñ–∏–ª—å–º–∞–º –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ
- –î–æ–±–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥—Ä—É–∑—å—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Ö —Å—Ç–∞—Ç—É—Å

---

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

![–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](docs/database-diagram.png)

### üìã –¢–∞–±–ª–∏—Ü—ã:

#### `films`
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–∞
- `name`, `description`, `release_date`, `duration`
- `mpa_id` ‚Äî –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –∫ —Ä–µ–π—Ç–∏–Ω–≥—É MPA

#### `users`
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `email`, `login`, `name`, `birthday`

#### `mpa_ratings`
- –°–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ (G, PG, PG-13, R, NC-17)

#### `genres`
- –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∂–∞–Ω—Ä—ã (–∫–æ–º–µ–¥–∏—è, –¥—Ä–∞–º–∞, –±–æ–µ–≤–∏–∫ –∏ —Ç.–¥.)

#### `film_genres`
- –°–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º –º–µ–∂–¥—É `films` –∏ `genres`

#### `friendships`
- `user_id`, `friend_id` ‚Äî –ø–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `status_id` ‚Äî —Å—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã

#### `film_likes`
- `film_id`, `user_id` ‚Äî –ª–∞–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ñ–∏–ª—å–º—É

---

## üí° –ü—Ä–∏–º–µ—Ä—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤

### –¢–æ–ø-5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤:
```sql
SELECT f.*
FROM films f
JOIN (
    SELECT film_id, COUNT(user_id) AS like_count
    FROM film_likes
    GROUP BY film_id
    ORDER BY like_count DESC
    LIMIT 5
) top_films ON f.id = top_films.film_id;
```

### –û–±—â–∏–µ –¥—Ä—É–∑—å—è –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```sql
SELECT u.*
FROM users u
JOIN friendships f1 ON u.id = f1.friend_id AND f1.user_id = 1
JOIN friendships f2 ON u.id = f2.friend_id AND f2.user_id = 2;
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
mvn clean install
mvn spring-boot:run
```

---

## üìÅ –§–∞–π–ª —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã: `docs/database-diagram.png`

---

## üß¨ schema.sql
```sql
-- –£–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
DROP TABLE IF EXISTS film_likes;
DROP TABLE IF EXISTS film_genres;
DROP TABLE IF EXISTS friendships;
DROP TABLE IF EXISTS films;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS genres;
DROP TABLE IF EXISTS mpa_ratings;

-- –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã
CREATE TABLE mpa_ratings (
    id INT PRIMARY KEY,
    name VARCHAR(20) NOT NULL
);

CREATE TABLE genres (
    id INT PRIMARY KEY,
    name VARCHAR(20) NOT NULL
);

CREATE TABLE films (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL CHECK (TRIM(name) <> ''),
    description VARCHAR(200),
    release_date DATE NOT NULL,
    duration INT CHECK (duration > 0),
    mpa_id INT,
    CONSTRAINT fk_mpa FOREIGN KEY (mpa_id) REFERENCES mpa_ratings(id)
);

CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    login VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    birthday DATE
);

CREATE TABLE friendships (
    user_id BIGINT NOT NULL,
    friend_id BIGINT NOT NULL,
    status_id INT DEFAULT 1,
    PRIMARY KEY (user_id, friend_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (friend_id) REFERENCES users(id)
);

CREATE TABLE film_likes (
    film_id BIGINT,
    user_id BIGINT,
    PRIMARY KEY (film_id, user_id),
    FOREIGN KEY (film_id) REFERENCES films(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE film_genres (
    film_id BIGINT,
    genre_id INT,
    PRIMARY KEY (film_id, genre_id),
    FOREIGN KEY (film_id) REFERENCES films(id),
    FOREIGN KEY (genre_id) REFERENCES genres(id)
);
```

---

## üíò –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å LikeStorage
```java
public interface LikeStorage {
    void addLike(Long filmId, Long userId);
    void removeLike(Long filmId, Long userId);
    List<Film> getTopLikedFilms(int count);
}
```

---

## üíæ LikeDbStorage
```java
@Repository
@RequiredArgsConstructor
public class LikeDbStorage implements LikeStorage {

    private final JdbcTemplate jdbcTemplate;
    private final FilmStorage filmStorage;

    @Override
    public void addLike(Long filmId, Long userId) {
        String sql = "INSERT INTO film_likes (film_id, user_id) VALUES (?, ?)";
        jdbcTemplate.update(sql, filmId, userId);
    }

    @Override
    public void removeLike(Long filmId, Long userId) {
        String sql = "DELETE FROM film_likes WHERE film_id = ? AND user_id = ?";
        jdbcTemplate.update(sql, filmId, userId);
    }

    @Override
    public List<Film> getTopLikedFilms(int count) {
        String sql = "SELECT film_id FROM film_likes GROUP BY film_id ORDER BY COUNT(user_id) DESC LIMIT ?";
        List<Long> filmIds = jdbcTemplate.queryForList(sql, Long.class, count);

        return filmIds.stream()
                .map(filmStorage::getById)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .collect(Collectors.toList());
    }
}
```